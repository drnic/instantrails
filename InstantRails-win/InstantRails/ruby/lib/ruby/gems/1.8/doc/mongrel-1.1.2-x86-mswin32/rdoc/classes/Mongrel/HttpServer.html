<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Class: Mongrel::HttpServer</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href="../.././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Class</strong></td>
          <td class="class-name-in-header">Mongrel::HttpServer</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../../files/lib/mongrel_rb.html">
                lib/mongrel.rb
                </a>
        <br />
            </td>
        </tr>

        <tr class="top-aligned-row">
            <td><strong>Parent:</strong></td>
            <td>
                Object
            </td>
        </tr>
        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">

    <div id="description">
      <p>
This is the main driver of <a href="../Mongrel.html">Mongrel</a>, while the
<a href="HttpParser.html">Mongrel::HttpParser</a> and <a
href="URIClassifier.html">Mongrel::URIClassifier</a> make up the majority
of how the server functions. It&#8216;s a very simple class that just has a
thread accepting connections and a simple <a
href="HttpServer.html#M000061">HttpServer.process_client</a> function to do
the heavy lifting with the <a href="../IO.html">IO</a> and Ruby.
</p>
<p>
You use it by doing the following:
</p>
<pre>
  server = HttpServer.new(&quot;0.0.0.0&quot;, 3000)
  server.register(&quot;/stuff&quot;, MyNiftyHandler.new)
  server.run.join
</pre>
<p>
The last line can be just server.run if you don&#8216;t want to join the
thread used. If you don&#8216;t though Ruby will mysteriously just exit on
you.
</p>
<p>
Ruby&#8216;s thread implementation is &quot;interesting&quot; to say the
least. Experiments with <b>many</b> different types of <a
href="../IO.html">IO</a> processing simply cannot make a dent in it. Future
releases of <a href="../Mongrel.html">Mongrel</a> will find other creative
ways to make threads faster, but don&#8216;t hold your breath until Ruby
1.9 is actually finally useful.
</p>

    </div>


   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000064">configure_socket_options</a>&nbsp;&nbsp;
      <a href="#M000063">graceful_shutdown</a>&nbsp;&nbsp;
      <a href="#M000060">new</a>&nbsp;&nbsp;
      <a href="#M000061">process_client</a>&nbsp;&nbsp;
      <a href="#M000062">reap_dead_workers</a>&nbsp;&nbsp;
      <a href="#M000066">register</a>&nbsp;&nbsp;
      <a href="#M000065">run</a>&nbsp;&nbsp;
      <a href="#M000068">stop</a>&nbsp;&nbsp;
      <a href="#M000067">unregister</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->

    <div id="section">





    <div id="attribute-list">
      <h3 class="section-bar">Attributes</h3>

      <div class="name-list">
        <table>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">acceptor</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">classifier</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">host</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">num_processors</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">port</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">throttle</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">timeout</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">workers</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        </table>
      </div>
    </div>
      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Class methods</h3>

      <div id="method-M000060" class="method-detail">
        <a name="M000060"></a>

        <div class="method-heading">
          <a href="HttpServer.src/M000060.html" target="Code" class="method-signature"
            onclick="popupCode('HttpServer.src/M000060.html');return false;">
          <span class="method-name">new</span><span class="method-args">(host, port, num_processors=950, throttle=0, timeout=60)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Creates a working server on host:port (strange things happen if port
isn&#8216;t a Number). Use HttpServer::run to start the server and
HttpServer.acceptor.join to join the thread that&#8216;s processing
incoming requests on the socket.
</p>
<p>
The num_processors optional argument is the maximum number of concurrent
processors to accept, anything over this is closed immediately to maintain
server processing performance. This may seem mean but it is the most
efficient way to deal with overload. Other schemes involve still parsing
the client&#8216;s request which defeats the point of an overload handling
system.
</p>
<p>
The throttle parameter is a sleep timeout (in hundredths of a second) that
is placed between socket.accept calls in order to give the server a cheap
throttle time. It defaults to 0 and actually if it is 0 then the sleep is
not done at all.
</p>
        </div>
      </div>

      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000064" class="method-detail">
        <a name="M000064"></a>

        <div class="method-heading">
          <a href="HttpServer.src/M000064.html" target="Code" class="method-signature"
            onclick="popupCode('HttpServer.src/M000064.html');return false;">
          <span class="method-name">configure_socket_options</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
        </div>
      </div>

      <div id="method-M000063" class="method-detail">
        <a name="M000063"></a>

        <div class="method-heading">
          <a href="HttpServer.src/M000063.html" target="Code" class="method-signature"
            onclick="popupCode('HttpServer.src/M000063.html');return false;">
          <span class="method-name">graceful_shutdown</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Performs a wait on all the currently running threads and kills any that
take too long. It waits by @timeout seconds, which can be set in
.initialize or via mongrel_rails. The @throttle setting does extend this
waiting period by that much longer.
</p>
        </div>
      </div>

      <div id="method-M000061" class="method-detail">
        <a name="M000061"></a>

        <div class="method-heading">
          <a href="HttpServer.src/M000061.html" target="Code" class="method-signature"
            onclick="popupCode('HttpServer.src/M000061.html');return false;">
          <span class="method-name">process_client</span><span class="method-args">(client)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Does the majority of the <a href="../IO.html">IO</a> processing. It has
been written in Ruby using about 7 different <a href="../IO.html">IO</a>
processing strategies and no matter how it&#8216;s done the performance
just does not improve. It is currently carefully constructed to make sure
that it gets the best possible performance, but anyone who thinks they can
make it faster is more than welcome to take a crack at it.
</p>
        </div>
      </div>

      <div id="method-M000062" class="method-detail">
        <a name="M000062"></a>

        <div class="method-heading">
          <a href="HttpServer.src/M000062.html" target="Code" class="method-signature"
            onclick="popupCode('HttpServer.src/M000062.html');return false;">
          <span class="method-name">reap_dead_workers</span><span class="method-args">(reason='unknown')</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Used internally to kill off any worker threads that have taken too long to
complete processing. Only called if there are too many processors currently
servicing. It returns the count of workers still active after the reap is
done. It only runs if there are workers to reap.
</p>
        </div>
      </div>

      <div id="method-M000066" class="method-detail">
        <a name="M000066"></a>

        <div class="method-heading">
          <a href="HttpServer.src/M000066.html" target="Code" class="method-signature"
            onclick="popupCode('HttpServer.src/M000066.html');return false;">
          <span class="method-name">register</span><span class="method-args">(uri, handler, in_front=false)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Simply registers a handler with the internal <a
href="URIClassifier.html">URIClassifier</a>. When the URI is found in the
prefix of a request then your handler&#8216;s HttpHandler::process method
is called. See <a
href="URIClassifier.html#M000079">Mongrel::URIClassifier#register</a> for
more information.
</p>
<p>
If you set in_front=true then the passed in handler will be put in the
front of the list for that particular URI. Otherwise it&#8216;s placed at
the end of the list.
</p>
        </div>
      </div>

      <div id="method-M000065" class="method-detail">
        <a name="M000065"></a>

        <div class="method-heading">
          <a href="HttpServer.src/M000065.html" target="Code" class="method-signature"
            onclick="popupCode('HttpServer.src/M000065.html');return false;">
          <span class="method-name">run</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Runs the thing. It returns the thread used so you can &quot;join&quot; it.
You can also access the HttpServer::acceptor attribute to get the thread
later.
</p>
        </div>
      </div>

      <div id="method-M000068" class="method-detail">
        <a name="M000068"></a>

        <div class="method-heading">
          <a href="HttpServer.src/M000068.html" target="Code" class="method-signature"
            onclick="popupCode('HttpServer.src/M000068.html');return false;">
          <span class="method-name">stop</span><span class="method-args">(synchronous=false)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Stops the acceptor thread and then causes the worker threads to finish off
the request queue before finally exiting.
</p>
        </div>
      </div>

      <div id="method-M000067" class="method-detail">
        <a name="M000067"></a>

        <div class="method-heading">
          <a href="HttpServer.src/M000067.html" target="Code" class="method-signature"
            onclick="popupCode('HttpServer.src/M000067.html');return false;">
          <span class="method-name">unregister</span><span class="method-args">(uri)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Removes any handlers registered at the given URI. See <a
href="URIClassifier.html#M000080">Mongrel::URIClassifier#unregister</a> for
more information. Remember this removes them <b>all</b> so the entire
processing chain goes away.
</p>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>